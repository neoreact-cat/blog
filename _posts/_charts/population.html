<script>
    google.charts.setOnLoadCallback(function () {
    var jsonData = $.ajax({
        url: "https://neoreact-cat.github.io/charts/pages/ru.russian-federal-budget-taxes-income-and-population/data.json",
        dataType: "json",
        async: true,
        success: function(json){
            var districtsPopulationGeo = drawDistrictsPopulationGeo(json, 'districts_population_geo')
            var districtsPopulationTable = drawDistrictsPopulationTable(json, 'districts_population_table')
            var regionsPopulationGeo = drawRegionsPopulationGeo(json, 'regions_population_geo')
            var regionsPopulationTable = drawRegionsPopulationTable(json, 'regions_population_table')
        }})
    })

    var strings = {}
    strings.District = 'District'
    strings.Region = 'District'
    strings.Population = 'Population'
    strings.TotalPercent = '% of total'
    strings.Total = "Total"

    function highlightIf(h, v) {
        return h ? '<span class="highlighted">' + v + '</span>' : v
    }

    function drawDistrictsPopulationGeo(json, element) {
        var data = new google.visualization.DataTable();
        data.addColumn('string', strings.District)
        data.addColumn('number', strings.TotalPercent)
        data.addColumn('number', strings.Population)
        
        var populationPercent = json.Population / 100
        json.Districts.forEach(function(d) {
            d.Regions.forEach(function(r) { data.addRow([ 
                { v: r.ISO3166Location, f: d.DistrictEn }, 
                parseFloat((d.Population / populationPercent).toFixed(1)),
                d.Population
            ]) }); 
        })
        data.sort({column: 1, desc: true}); 

        var view = new google.visualization.DataView(data);
        view.setColumns([0,1,2])

        var geo = new google.visualization.GeoChart(document.getElementById(element));

        geo.draw(view, { 
            dataMode: 'regions', 
            displayMode: 'regions', 
            region: 'RU', 
            resolution: 'provinces',
            width: '100%', 
            height:'100%',
            backgroundColor: '#121111',
            datalessRegionColor: '#121111',
            colorAxis: { colors: ['#054604', '#0FD90C'] } });

        return geo
    }

    function drawDistrictsPopulationTable(json, element) {
        var data = new google.visualization.DataTable();
        data.addColumn('string', strings.District)
        data.addColumn('number', strings.Population)
        data.addColumn('number', strings.TotalPercent)

        var populationPercent = json.Population / 100
        json.Districts.forEach(function(d) { 
            var districtPopulationPercent = d.Population / 100
            data.addRow([
                d.DistrictEn, 
                d.Population,
                { v: (d.Population / populationPercent), f: parseFloat((d.Population / populationPercent).toFixed(1)) + "%" }
            ]) 
        });

        data.sort({column: 1, desc: true}); 

        data.addRow([ 
            strings.Total, 
            { v: json.Population, f: highlightIf(true, json.Population.toLocaleString('en')) },
            { v: 100, f: "100%" }
        ])

        var view = new google.visualization.DataView(data);
        view.setColumns([0,1,2])

        var table = new google.visualization.Table(document.getElementById(element));
        table.draw(view, { 
            showRowNumber: false, 
            width: '100%', 
            height: '100%', 
            sort: 'disable',
            allowHtml: true
        })

        return table
    }

    function drawRegionsPopulationGeo(json, element) {
        var data = new google.visualization.DataTable();
        data.addColumn('string', strings.Region)
        data.addColumn('number', strings.TotalPercent)
        data.addColumn('number', strings.Population)
        
        var populationPercent = json.Population / 100
        json.Districts.forEach(function(d) {
            d.Regions.forEach(function(r) { data.addRow([ 
                { v: r.ISO3166Location, f: r.RegionEn }, 
                parseFloat((r.Population / populationPercent).toFixed(1)),
                r.Population
            ]) }); 
        })
        data.sort({column: 1, desc: true}); 

        var view = new google.visualization.DataView(data);
        view.setColumns([0,1,2])

        var geo = new google.visualization.GeoChart(document.getElementById(element));

        geo.draw(view, { 
            dataMode: 'regions', 
            displayMode: 'regions', 
            region: 'RU', 
            resolution: 'provinces',
            width: '100%', 
            height:'100%',
            backgroundColor: '#121111',
            datalessRegionColor: '#121111',
            colorAxis: { colors: ['#054604', '#0FD90C', '#10E00D'] } });

        return geo
    }

    function drawRegionsPopulationTable(json, element) {
        var data = new google.visualization.DataTable();
        data.addColumn('string', strings.Region)
        data.addColumn('number', strings.Population)
        data.addColumn('number', strings.TotalPercent)

        var populationPercent = json.Population / 100
        json.Districts.forEach(function(d) { 
            d.Regions.forEach(function(r) {
                var regionPopulationPercent = r.Population / 100
                data.addRow([
                    r.RegionEn,
                    r.Population,
                    { v: (r.Population / populationPercent), f: parseFloat((r.Population / populationPercent).toFixed(1)) + "%" }
                ])
            })
        });

        data.sort({column: 1, desc: true}); 

        data.addRow([ 
            strings.Total, 
            { v: json.Population, f: highlightIf(true, json.Population.toLocaleString('en')) },
            { v: 100, f: "100%" }
        ])

        var view = new google.visualization.DataView(data);
        view.setColumns([0,1,2])

        var table = new google.visualization.Table(document.getElementById(element));
        table.draw(view, { 
            showRowNumber: false, 
            width: '100%', 
            height: '100%', 
            sort: 'disable',
            allowHtml: true
        })

        return table
    }

</script>