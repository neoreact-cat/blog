<script>
    google.charts.setOnLoadCallback(function () {
    var jsonData = $.ajax({
        url: "https://neoreact-cat.github.io/charts/pages/ru.russian-federal-budget-taxes-income-and-population/data.json",
        dataType: "json",
        async: true,
        success: function(json){
            var districtsTable = drawDistrictsTable(json)
            var districtsPopulationGeo = drawDistrictsPopulationGeo(json)
            var districtsPopulationSankey = drawDistrictsPopulationSankey(json)

        }})
    })

    var strings = {}
    strings.District = 'District'
    strings.Population = 'Population'
    strings.PopulationUrban = 'Urban Population'
    strings.PopulationRural = 'Rural Population'
    strings.Urban = 'Urban'
    strings.Rural = 'Rural'
    strings.TotalPercent = '% of total'
    strings.UrbanPercent = '% of urbanization'
    strings.Total = "Total"

    function drawDistrictsTable(json) {
        var data = new google.visualization.DataTable();
        data.addColumn('string', strings.District)
        data.addColumn('number', strings.Population)
        data.addColumn('number', strings.TotalPercent)
        data.addColumn('number', strings.Urban)
        data.addColumn('number', strings.Rural)
        data.addColumn('number', strings.UrbanPercent)

        var maxRuralId
        var maxRural = 0
        var minUrbanizationId
        var minUrbanization = 100
        json.Districts.forEach(d => { 
            if(d.PopulationRural > maxRural) {
                maxRural = d.PopulationRural
                maxRuralId = d.Id
            }
            var districtPopulationPercent = d.Population / 100
            if((d.PopulationUrban / districtPopulationPercent) < minUrbanization) {
                minUrbanization = (d.PopulationUrban / districtPopulationPercent)
                minUrbanizationId = d.Id
            }
        })

        function highlightIf(h, v) {
            return h ? '<span class="highlighted">' + v + '</span>' : v
        }

        var populationPercent = json.Population / 100
        json.Districts.forEach(d => { 
            var districtPopulationPercent = d.Population / 100
            data.addRow([
                d.DistrictEn, 
                d.Population,
                { v: (d.Population / populationPercent), f: parseFloat((d.Population / populationPercent).toFixed(1)) + "%" },
                d.PopulationUrban,
                { 
                    v: d.PopulationRural , 
                    f: highlightIf(maxRuralId == d.Id,d.PopulationRural.toLocaleString('en')) 
                },
                { 
                    v: (d.PopulationUrban / districtPopulationPercent), 
                    f: highlightIf(minUrbanizationId == d.Id, parseFloat((d.PopulationUrban / districtPopulationPercent).toFixed(1)) + "%") 
                }
            ]) 
        });

        data.sort({column: 1, desc: true}); 

        data.addRow([ 
            strings.Total, 
            json.Population,
            { v: 100, f: "100%" },
            json.PopulationUrban,
            json.PopulationRural,
            { v: (json.PopulationUrban / populationPercent), f: parseFloat((json.PopulationUrban / populationPercent).toFixed(1)) + "%" }
        ])

        var view = new google.visualization.DataView(data);
        view.setColumns([0,1,2,3,4,5])

        var table = new google.visualization.Table(document.getElementById('districts_population_table'));
        table.draw(view, { 
            showRowNumber: false, 
            width: '100%', 
            height: '100%', 
            sort: 'disable',
            allowHtml: true
        })

        return table
    }

    function drawDistrictsPopulationGeo(json) {
        var data = new google.visualization.DataTable();
        data.addColumn('string', strings.Region)
        data.addColumn('number', strings.TotalPercent)
        data.addColumn('number', strings.Population)
        
        var populationPercent = json.Population / 100
        json.Districts.forEach(d => {
            d.Regions.forEach(r => { data.addRow([ 
                { v: r.ISO3166Location, f: d.DistrictEn }, 
                parseFloat((d.Population / populationPercent).toFixed(1)),
                d.Population
            ]) }); 
        })
        data.sort({column: 1, desc: true}); 

        var view = new google.visualization.DataView(data);
        view.setColumns([0,1,2])

        var geo = new google.visualization.GeoChart(document.getElementById('districts_population_geo'));

        geo.draw(view, { 
            dataMode: 'regions', 
            displayMode: 'regions', 
            region: 'RU', 
            resolution: 'provinces',
            width: '100%', 
            height:'100%',
            backgroundColor: '#121111',
            datalessRegionColor: '#121111',
            colorAxis: { colors: ['#054604', '#0FD90C'] } });

        return geo
    }

    function drawDistrictsPopulationSankey(json) {
        var data = new google.visualization.DataTable();
        data.addColumn('string', 'From')
        data.addColumn('string', 'To')
        data.addColumn('number', strings.Population)
        data.addColumn('number', strings.UrbanPercent)

        var populationPercent = json.Population / 100
        json.Districts.forEach(d => { 
            var districtPopulationPercent = d.Population / 100
            data.addRow([ 
                d.DistrictEn, 
                strings.Total, 
                d.Population, 
                parseFloat((d.PopulationUrban / districtPopulationPercent).toFixed(1))
        ]) })

        var chart = new google.visualization.Sankey(document.getElementById('districts_population_sankey'));
        chart.draw(data, {
            width: '100%', 
            height:'400',
            backgroundColor: '#121111',
            sankey: {
                node: {
                    colors: ['#0FD90C'],
                    label: {
                        color: 'white'
                    }
                }
            }
        });
    }

</script>