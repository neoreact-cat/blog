<script>
    google.charts.setOnLoadCallback(function () {
    var jsonData = $.ajax({
        url: "https://neoreact-cat.github.io/charts/pages/ru.russian-federal-budget-taxes-income-and-population/data.json",
        dataType: "json",
        async: true,
        success: function(json){
            // var districtsTable = drawDistrictsTable(json)
            var districtsPopulationGeo = drawDistrictsPopulationGeo(json)
            // var districtsPopulationPie = drawDistrictsPopulationPie(json)

            // google.visualization.events.addListener(districtsTable, 'select', function (e) {
            //     var selectedDistrict = districtsTable.getSelection().row
            //     // var 
            //     // districtsPopulationPie.setSelection(districtsTable.getSelection());
            // });

            // google.visualization.events.addListener(districtsPopulationPie, 'select', function (e) {
            //     districtsTable.setSelection(districtsPopulationPie.getSelection());
            // });
        }})
    })

    var strings = {}
    strings.District = 'District'
    strings.Population = 'Population'
    strings.PopulationPercent = '% of total'
    strings.Total = "Total"

    function drawDistrictsTable(json) {
        var data = new google.visualization.DataTable();
        data.addColumn('string', strings.District)
        data.addColumn('number', strings.Population)
        data.addColumn('number', strings.PopulationPercent)

        var populationPersent = json.TotalPopulation / 100
        json.Districts.forEach(d => { data.addRow([
            d.DistrictEn, 
            d.Population,
            { v: (d.Population / populationPersent), f: parseFloat((d.Population / populationPersent).toFixed(1)) + "%" }
        ]) });

        data.sort({column: 1, desc: true}); 

        data.addRow([ 
            strings.Total, 
            json.TotalPopulation,
            { v: 100, f: "100%" }
        ])

        var view = new google.visualization.DataView(data);
        view.setColumns([0,1,2])

        var table = new google.visualization.Table(document.getElementById('districts_population_table'));
        table.draw(view, { 
            showRowNumber: false, 
            width: '100%', 
            height: '100%', 
            sort: 'disable'//,
            // cssClassNames = {
            //     headerRow: 'chartTableHeaderRow',
            //     hoverTableRow: 'chartTableHighlight'
            // }
        })

        return table
    }

    function drawDistrictsPopulationGeo(json) {
        var data = new google.visualization.DataTable();
        data.addColumn('string', strings.Region)
        data.addColumn('number', strings.PopulationPercent)
        data.addColumn('number', strings.Population)
        
        var populationPersent = json.TotalPopulation / 100
        json.Districts.forEach(d => {
            d.Regions.forEach(r => { data.addRow([ 
                { v: r.ISO3166Location, f: d.DistrictEn }, 
                parseFloat((d.Population / populationPersent).toFixed(1)),
                d.Population
            ]) }); 
        })
        data.sort({column: 1, desc: true}); 

        var view = new google.visualization.DataView(data);
        view.setColumns([0,1,2])

        var geo = new google.visualization.GeoChart(document.getElementById('districts_population_geo'));

        geo.draw(view, { 
            dataMode: 'regions', 
            displayMode: 'regions', 
            region: 'RU', 
            resolution: 'provinces',
            width: '100%', 
            height:'100%',
            backgroundColor: '#121111',
            datalessRegionColor: '#121111',
            colorAxis: { colors: ['#054604', '#0FD90C'] } });

        return geo
    }


    function drawDistrictsPopulationPie(json) {
        var data = new google.visualization.DataTable();
        data.addColumn('string', strings.District)
        data.addColumn('number', strings.Population)

        json.Districts.forEach(d => { data.addRow([
            d.DistrictEn, 
            d.Population
        ]) });
        data.sort({column: 1, desc: true}); 

        var chart = new google.visualization.PieChart(document.getElementById('districts_population_pie'));
        
        chart.draw(data, { 
            pieHole: 0, 
            width: '600', 
            height: '600', 
            legend: 'none',
            backgroundColor: '#121111',
            chartArea:{left:20,top:20,width:'60%',height:'60%'} });

        return chart
    }
</script>